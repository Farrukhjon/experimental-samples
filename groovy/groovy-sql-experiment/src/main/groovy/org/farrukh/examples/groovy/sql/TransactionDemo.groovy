/*
 * Copyright (C) F.D. Sattorov Systems, Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by F.D. Sattorov <farrukhjon.sattorov@gmail.com>, May 2016.
 */

package org.farrukh.examples.groovy.sql

import java.sql.ResultSet

class TransactionDemo {

    static void main(String[] args) {

        def sql = Connection.connect()

        sql.execute '''
                        CREATE TABLE Author (
                            id          INTEGER GENERATED BY DEFAULT AS IDENTITY,
                            firstName   VARCHAR(64),
                            lastName    VARCHAR(64)
                          );
                        '''

        def authors = ['Ali': 'Valizoda', 'Sami': 'Ganizoda', 'Surayo': 'Aminzoda']
        def insertQuery = "INSERT INTO Author (firstName, lastName) VALUES (?, ?)"

        authors.each { firstName, lastName ->
            def params = [firstName, lastName]
            sql.executeInsert insertQuery, params
        }

        def expected = ['Ali Valizoda', 'Sami Ganizoda', 'Surayo Aminzoda']

        def rowNum = 0
        sql.query('SELECT id, firstName, lastName FROM Author') { ResultSet rs ->
            while (rs.next()) {
                def id = rs.getInt(1)
                def firstName = rs.getString(2)
                def lastName = rs.getString('lastName')
                assert expected[rowNum++] == "$firstName $lastName"

                println "id = $id firstName = $firstName lastName = $lastName"
            }
        }

        sql.close()
    }

}
